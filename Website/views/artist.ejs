<html>
  <head>
  <script type='text/javascript' src="//code.jquery.com/jquery-1.10.1.min.js"></script>
  <script type='text/javascript' src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script type='text/javascript' src="//developer.spotify.com/web-api/static/css/cached.css"></script>
  <link href='https://fonts.googleapis.com/css?family=Megrim' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css"> <!-- load bootstrap css -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css"> <!-- load fontawesome -->
    
  <title>EarBuds</title>

  <style>
        h1 {
              color:#006666;
              font-family: 'Megrim', sans-serif;
              font-weight: bolder;
              font-size: 200%;
            }
        h2 {
              color:#006666;
              font-family: sans-serif;
              font-weight: bolder;
              text-align: center;
        }
        h3 {
            color:#006666;
            font-family: 'Megrim', sans-serif;
            font-weight: bolder;
            font-size: 250%;     
            text-align: center;
        }
        .text {
              color:#006666;
              font-family: sans-serif;
              font-weight: bolder;
              font-size: 150%;
            }
        .img {
              border-radius: 6px; 
              border: 1px solid black ;   
              max-width:100%; 
              max-height:100%;
            }
        .userbutton {
              margin-bottom: 10px;
        }
            
        /*CSS for album artwork! Do not modify!*/    
        body {
              padding: 20px;
            }
         #search-form,
        .form-control {
              margin-bottom: 10px;
            }
        .cover {
              width: 300px;
              height: 300px;
              display: inline-block;
              background-size: cover;
            }
        .cover:hover {
              cursor: pointer;
            }
        .cover.playing {
              border: 5px solid #e45343;
            }
  </style>
  
      <div class="col-sm-9 well" style="margin-left: 2%">
        <h1>Search for another Artist</h1>
        <form id="search-form">
        <input type="text" id="query" value="" class="form-control" placeholder="Type an Artist Name" />
        <input type="submit" id="search" class="btn btn-warning btn-lgt" value="Search" />
        </form>
          <div class="home">
            <p>Or go <a href="/">home</a>.</p>
          </div>
        <div id="results"></div>
      </div>
      
            <!-- User Box only appears when logged In -->
      <% if (typeof user !== 'undefined') { %>
        <div class="col-sm-2 well" style="margin-left: 4%; margin-right: 2%">
          <h2><span class="fa fa-user"></span><%=user.local.username%></h2>
            <div class="col-sm-6">
              <img src="<%=user.local.imgurl%>" alt="avatar" class="img">
            </div>
            <div class="col-sm-6" style="text-align: center">
              <div class="userbutton">
                <a href="/logout" class="btn btn-warning btn-lgt btn-block" style="text-align: center">Logout</a>
                <a href="/profile" class="btn btn-warning btn-lgt btn-block" style="text-align: center">Profile</a>
              </div>
            </div>
        </div>
      <% } else { %>
      <div class="col-sm-2 well" style="margin-left: 4%; margin-right: 2%">
        <h3>E A R B U D S</h3>
        <a href="/login" class="btn btn-warning btn-lgt btn-block"><span class="fa fa-user"></span> Login </a>
        
        <a href="/signup" class="btn btn-warning btn-lgt btn-block"><span class="fa fa-pencil-square-o"></span> Signup </a>
      </div>
      <% } %>
      
      <% if (typeof user !== 'undefined') { %>
      <div class="col-sm-2 well" style="margin-left: 4%; margin-right: 2%">      
        <h2 style="text-align: center"><span class="fa fa-headphones"></span><%=typeahead%></h2>
          <div class="userbutton">
            <form action="/fave" method="GET">
                <input type="hidden" name="fave" value="<%=typeahead%>">
                <button type="submit" class="btn btn-warning btn-lgt btn-block" style="text-align: center">Favorite</button>
            </form>
          </div>
          <div class="userbutton">
            <form action="/unfave" method="GET">
                <input type="hidden" name="unfave" value="<%=typeahead%>">
                <button type="submit" class="btn btn-warning btn-lgt btn-block" style="text-align: center">UnFavorite</button>
            </form>
          </div>
      </div>
      <% } else { %>
      <div class="col-sm-2 well" style="margin-left: 4%; margin-right: 2%">    
        <h2 style="text-align: center"><span class="fa fa-headphones"></span><%=typeahead%></h2>   
      </div>
      <% } %>
        
  </head>
  <body>
    
  <!--Javascript code-->
  <script id="results-template" type="text/x-handlebars-template">
  {{#each albums.items}}
  <div style="background-image:url({{images.0.url}})" data-album-id="{{id}}" class="cover"></div>
  {{/each}}
  </script>
  
  <div class="wrapper">
    <script>
        var SpotifyWebApi = require('spotify-web-api-node');
          var spotifyApi = new SpotifyWebApi();
              document.getElementById('search-form').addEventListener('submit', function(e) {
                e.preventDefault();
                spotifyApi.getArtist(document.getElementById('query').value)
                    .then(function(data) {
                    console.log('Artist information', data.body);
                    }, function(err) {
                    console.error(err);
                    });
            }, false); 
    </script>
  </div>
</body>
<script>
  // Prefill the form and submit on page load
  window.onload = function preFill() {
    searchAlbums('<%=typeahead%>');
    spotifyApi.getArtist('<%=typeahead%>')
      .then(function(data) {
      console.log('Artist information', data.body);
      }, function(err) {
      console.error(err);
    });
  };
  
  // find template and compile it
  var templateSource = document.getElementById('results-template').innerHTML,
    template = Handlebars.compile(templateSource),
    resultsPlaceholder = document.getElementById('results'),
    playingCssClass = 'playing',
    audioObject = null;
  
  var fetchTracks = function(albumId, callback) {
    $.ajax({
      url: 'https://api.spotify.com/v1/albums/' + albumId,
      success: function(response) {
        callback(response);
      }
    });
  };
  
  var searchAlbums = function(query) {
    $.ajax({
      url: 'https://api.spotify.com/v1/search',
      data: {
        q: query,
        type: 'album'
      },
      success: function(response) {
        resultsPlaceholder.innerHTML = template(response);
      }
    });
  };
  
  results.addEventListener('click', function(e) {
    var target = e.target;
    if (target !== null && target.classList.contains('cover')) {
      if (target.classList.contains(playingCssClass)) {
        audioObject.pause();
      } else {
        if (audioObject) {
          audioObject.pause();
        }
        fetchTracks(target.getAttribute('data-album-id'), function(data) {
          audioObject = new Audio(data.tracks.items[0].preview_url);
          audioObject.play();
          target.classList.add(playingCssClass);
          audioObject.addEventListener('ended', function() {
            target.classList.remove(playingCssClass);
          });
          audioObject.addEventListener('pause', function() {
            target.classList.remove(playingCssClass);
          });
        });
      }
    }
  });
  
  document.getElementById('search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    searchAlbums(document.getElementById('query').value);
  }, false);
</script>
<!--End of Javascript code-->
</html>