<script>
  // add typeahead for this page? 
  // and fix the fucking css. shits ugly.
  
  
  // NOT RETURNING ALBUMS? *needtofix* FIXME
</script>

<html>
    <head>
    <link href='https://fonts.googleapis.com/css?family=Megrim' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css"> <!-- load bootstrap css -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css"> <!-- load fontawesome -->
    <title>Welcome to EarBuds!</title>
    <style>
            h1 {
                color:#006666;
                font-family: 'Megrim', serif;
                font-weight: bolder;
                font-size: 200%;
                text-align: right;
            }
    </style>

  <div class="container">
    <h1>Search for another Artist</h1>
    <form id="search-form">
      <input type="text" id="query" value="" class="form-control" placeholder="Type an Artist Name" />
      <input type="submit" id="search" class="btn btn-primary" value="Search" />
    </form>
    <div id="results"></div>
  </div>
  <script id="results-template" type="text/x-handlebars-template">
    {{#each albums.items}}
    <div style="background-image:url({{images.0.url}})" data-album-id="{{id}}" class="cover"></div>
    {{/each}}
  </script>


<style> 
  body {
    padding: 20px;
  }
  
  #search-form,
  .form-control {
    margin-bottom: 20px;
  }
  
  .cover {
    width: 300px;
    height: 300px;
    display: inline-block;
    background-size: cover;
  }
  
  .cover:hover {
    cursor: pointer;
  }
  
  .cover.playing {
    border: 5px solid #e45343;
  }
</style>



<script>

  // find template and compile it
  var templateSource = document.getElementById('results-template').innerHTML,
    template = Handlebars.compile(templateSource),
    resultsPlaceholder = document.getElementById('results'),
    playingCssClass = 'playing',
    audioObject = null;
  
  var fetchTracks = function(albumId, callback) {
    $.ajax({
      url: 'https://api.spotify.com/v1/albums/' + albumId,
      success: function(response) {
        callback(response);
      }
    });
  };
  
  var searchAlbums = function(query) {
    $.ajax({
      url: 'https://api.spotify.com/v1/search',
      data: {
        q: query,
        type: 'album'
      },
      success: function(response) {
        resultsPlaceholder.innerHTML = template(response);
      }
    });
  };
  
  results.addEventListener('click', function(e) {
    var target = e.target;
    if (target !== null && target.classList.contains('cover')) {
      if (target.classList.contains(playingCssClass)) {
        audioObject.pause();
      } else {
        if (audioObject) {
          audioObject.pause();
        }
        fetchTracks(target.getAttribute('data-album-id'), function(data) {
          audioObject = new Audio(data.tracks.items[0].preview_url);
          audioObject.play();
          target.classList.add(playingCssClass);
          audioObject.addEventListener('ended', function() {
            target.classList.remove(playingCssClass);
          });
          audioObject.addEventListener('pause', function() {
            target.classList.remove(playingCssClass);
          });
        });
      }
    }
  });
  
  document.getElementById('search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    searchAlbums(document.getElementById('query').value);
  }, false);

</script>
